parameters:
  service_connection_name: ''
  working_directory: '.'
  tfstate_storage_account_name: ''
  tfstate_container_name: ''
  tfstate_key: ''
  tfstate_access_key: ''

steps:
  - task: AzureCLI@2
    displayName: Init
    inputs:
      azureSubscription: ${{ parameters.service_connection_name }}
      scriptType: bash
      scriptLocation: inlineScript
      addSpnToEnvironment: true
      workingDirectory: ${{ parameters.working_directory }}
      inlineScript: |
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_CLIENT_SECRET=$servicePrincipalKey
        export ARM_SUBSCRIPTION_ID=$(az account show -o json | jq -r '.id')
        export ARM_TENANT_ID=$(az account show -o json | jq -r '.tenantId')
        
        terraform init \
          -backend-config="storage_account_name=${{ parameters.tfstate_storage_account_name }}" \
          -backend-config="container_name=${{ parameters.tfstate_container_name }}" \
          -backend-config="key=${{ parameters.tfstate_key }}" \
          -backend-config="access_key=${{ parameters.tfstate_access_key }}"